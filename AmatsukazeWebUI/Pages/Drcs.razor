@page "/drcs"
@using Amatsukaze.Shared
@inject IAmatsukazeApi Api
@inject AmatsukazeWebUI.Api.ApiBaseAddress ApiBase
@inject NavigationManager Nav

<h3>DRCS外字</h3>

<div class="drcs-toolbar">
    <button class="btn btn-primary" @onclick="ReloadAsync" disabled="@_loading">Reload</button>
    <label class="settings-check drcs-filter">
        <input type="checkbox" checked="@_noMapOnly" @onchange="ToggleNoMapOnly" />
        未マッピングのみ
    </label>
</div>

@if (_loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(_error))
{
    <p style="color: red;">@_error</p>
}
else if (FilteredItems.Count == 0)
{
    <p>No DRCS items.</p>
}
else
{
    <div class="drcs-list">
        @foreach (var item in FilteredItems)
        {
            var md5 = item.Md5 ?? string.Empty;
            <div class="drcs-row">
                <div class="drcs-image">
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <img src="@GetImageUrl(item.Md5)" alt="@item.Md5" />
                    }
                    else
                    {
                        <div class="drcs-image-placeholder"></div>
                    }
                </div>
                <div class="drcs-map">
                    <input class="form-control" value="@GetMapInput(md5)" @oninput="(e => OnMapInput(md5, e))" />
                </div>
                <div class="drcs-actions">
                    <button class="btn btn-primary btn-sm"
                            @onclick="() => ApplyMapAsync(item)"
                            disabled="@(!IsMapModified(item))">
                        @(string.IsNullOrEmpty(item.MapStr) ? "マッピング追加" : "変更")
                    </button>
                    <button class="btn btn-danger btn-sm"
                            @onclick="() => DeleteMapAsync(item)"
                            disabled="@string.IsNullOrEmpty(item.MapStr)">
                        削除
                    </button>
                    <div class="drcs-appearance">
                        <button class="btn btn-secondary btn-sm" @onclick="() => ToggleAppearanceAsync(item)">
                            出現位置確認
                        </button>
                        @if (_appearanceOpenMd5 == item.Md5)
                        {
                            <div class="drcs-appearance-popup">
                                @if (_appearanceLoading)
                                {
                                    <div>Loading...</div>
                                }
                                else if (_appearanceItems.Count == 0)
                                {
                                    <div>出現位置なし</div>
                                }
                                else
                                {
                                    <ul>
                                        @foreach (var line in _appearanceItems)
                                        {
                                            <li>@line</li>
                                        }
                                    </ul>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private readonly List<DrcsView> _items = new();
    private readonly Dictionary<string, string> _imageUrls = new();
    private readonly Dictionary<string, string> _mapInputs = new();
    private string? _error;
    private bool _loading = true;
    private bool _noMapOnly;
    private string? _appearanceOpenMd5;
    private List<string> _appearanceItems = new();
    private bool _appearanceLoading;

    protected override Task OnInitializedAsync() => ReloadAsync();

    private async Task ReloadAsync()
    {
        _loading = true;
        _error = null;
        _items.Clear();
        _imageUrls.Clear();
        _appearanceOpenMd5 = null;
        _appearanceItems = new List<string>();

        var res = await Api.GetDrcsAsync();
        if (!res.Ok)
        {
            _error = res.Error ?? "Failed to load DRCS.";
        }
        else if (res.Data != null)
        {
            _items.AddRange(res.Data);
            BuildImageUrls();
            BuildMapInputs();
        }

        _loading = false;
    }

    private void BuildImageUrls()
    {
        var baseUri = ApiBase.Uri;
        if (string.Equals(baseUri.Scheme, Uri.UriSchemeFile, StringComparison.OrdinalIgnoreCase))
        {
            baseUri = new Uri(Nav.BaseUri);
        }
        var baseText = baseUri.ToString().TrimEnd('/');
        foreach (var item in _items)
        {
            if (string.IsNullOrWhiteSpace(item.ImageUrl) || string.IsNullOrWhiteSpace(item.Md5))
            {
                continue;
            }
            var tail = item.ImageUrl.StartsWith("/", StringComparison.Ordinal) ? item.ImageUrl : "/" + item.ImageUrl;
            _imageUrls[item.Md5] = baseText + tail;
        }
    }

    private string GetImageUrl(string? md5)
    {
        if (string.IsNullOrWhiteSpace(md5))
        {
            return string.Empty;
        }
        return _imageUrls.TryGetValue(md5, out var url) ? url : string.Empty;
    }

    private void BuildMapInputs()
    {
        _mapInputs.Clear();
        foreach (var item in _items)
        {
            if (string.IsNullOrWhiteSpace(item.Md5))
            {
                continue;
            }
            _mapInputs[item.Md5] = item.MapStr ?? string.Empty;
        }
    }

    private IReadOnlyList<DrcsView> FilteredItems
        => _noMapOnly
            ? _items.Where(i => string.IsNullOrWhiteSpace(i.MapStr)).ToList()
            : _items;

    private void ToggleNoMapOnly(ChangeEventArgs e)
    {
        _noMapOnly = e.Value is bool b && b;
    }

    private string GetMapInput(string md5)
    {
        return _mapInputs.TryGetValue(md5, out var value) ? value : string.Empty;
    }

    private void OnMapInput(string md5, ChangeEventArgs e)
    {
        _mapInputs[md5] = e.Value?.ToString() ?? string.Empty;
    }

    private bool IsMapModified(DrcsView item)
    {
        if (string.IsNullOrWhiteSpace(item.Md5))
        {
            return false;
        }
        var current = item.MapStr ?? string.Empty;
        return _mapInputs.TryGetValue(item.Md5, out var input) && input != current;
    }

    private async Task ApplyMapAsync(DrcsView item)
    {
        if (string.IsNullOrWhiteSpace(item.Md5))
        {
            return;
        }
        var mapStr = _mapInputs.TryGetValue(item.Md5, out var input) ? input : string.Empty;
        var res = await Api.UpdateDrcsMapAsync(item.Md5, mapStr);
        if (!res.Ok)
        {
            _error = res.Error ?? "Failed to update mapping.";
            return;
        }
        await ReloadAsync();
    }

    private async Task DeleteMapAsync(DrcsView item)
    {
        if (string.IsNullOrWhiteSpace(item.Md5))
        {
            return;
        }
        var res = await Api.DeleteDrcsMapAsync(item.Md5);
        if (!res.Ok)
        {
            _error = res.Error ?? "Failed to delete mapping.";
            return;
        }
        await ReloadAsync();
    }

    private async Task ToggleAppearanceAsync(DrcsView item)
    {
        if (string.IsNullOrWhiteSpace(item.Md5))
        {
            return;
        }
        if (_appearanceOpenMd5 == item.Md5)
        {
            _appearanceOpenMd5 = null;
            _appearanceItems = new List<string>();
            return;
        }
        _appearanceOpenMd5 = item.Md5;
        _appearanceLoading = true;
        _appearanceItems = new List<string>();
        var res = await Api.GetDrcsAppearanceAsync(item.Md5);
        _appearanceLoading = false;
        if (!res.Ok || res.Data == null)
        {
            _appearanceItems = new List<string>();
            return;
        }
        _appearanceItems = res.Data.Items ?? new List<string>();
    }
}
