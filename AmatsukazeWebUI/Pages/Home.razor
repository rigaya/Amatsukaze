@page "/info"
@using Amatsukaze.Shared
@inject IAmatsukazeApi Api

<h1>情報</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(_error))
{
    <p style="color: red;">@_error</p>
}
else if (_system == null)
{
    <p>No data.</p>
}
else
{
    <table class="info-table">
        <tr><th>Host</th><td>@(_system.ServerInfo?.HostName ?? "-")</td></tr>
        <tr><th>Version</th><td>@(_system.ServerInfo?.Version ?? "-")</td></tr>
        <tr>
            <th>Latest</th>
            <td>
                @if (_latestRelease != null && !string.IsNullOrEmpty(_latestRelease.Tag) && !string.IsNullOrEmpty(_latestRelease.Url))
                {
                    <a href="@_latestRelease.Url" target="_blank" rel="noopener noreferrer">@_latestRelease.Tag</a>
                }
                else
                {
                    <span>-</span>
                }
            </td>
        </tr>
        <tr><th>Platform</th><td>@(_system.ServerInfo?.Platform ?? "-")</td></tr>
    </table>

    <h2 class="info-section-title">ディスク</h2>
    @if (_system.Disks == null || _system.Disks.Count == 0)
    {
        <p>-</p>
    }
    else
    {
        <table class="disk-table">
            <thead>
                <tr>
                    <th>Path</th>
                    <th class="disk-num">Total</th>
                    <th class="disk-num">Free</th>
                    <th class="disk-num">Used</th>
                    <th class="disk-num">Used%</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var disk in _system.Disks)
                {
                    <tr>
                        <td>@(disk.Path ?? "-")</td>
                        <td class="disk-num">@FormatBytes(disk.CapacityBytes)</td>
                        <td class="disk-num">@FormatBytes(disk.FreeBytes)</td>
                        <td class="disk-num">@FormatBytes(disk.UsedBytes)</td>
                        <td class="disk-num">@FormatPercent(disk.UsedRatio)</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private SystemSnapshot? _system;
    private LatestReleaseInfo? _latestRelease;
    private string? _error;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
        await LoadLatestReleaseAsync();
        _loading = false;
    }

    private async Task ReloadAsync()
    {
        var res = await Api.GetSystemAsync();
        if (!res.Ok)
        {
            _error = res.Error ?? "Failed to load.";
            return;
        }
        _error = null;
        _system = res.Data;
    }

    private async Task LoadLatestReleaseAsync()
    {
        var res = await Api.GetLatestReleaseAsync();
        if (res.Ok && res.Data != null)
        {
            _latestRelease = res.Data;
        }
    }

    private static string FormatBytes(long bytes)
    {
        const double unit = 1024.0;
        var size = Math.Max(0, (double)bytes);
        var suffix = "B";
        if (size >= unit)
        {
            size /= unit;
            suffix = "KiB";
        }
        if (size >= unit)
        {
            size /= unit;
            suffix = "MiB";
        }
        if (size >= unit)
        {
            size /= unit;
            suffix = "GiB";
        }
        if (size >= unit)
        {
            size /= unit;
            suffix = "TiB";
        }
        return $"{size:0.##} {suffix}";
    }

    private static string FormatPercent(double ratio)
    {
        var value = Math.Max(0.0, Math.Min(1.0, ratio));
        return $"{value * 100:0.#}%";
    }
}
