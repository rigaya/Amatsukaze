@page "/info"
@using Amatsukaze.Shared
@inject IAmatsukazeApi Api

<h1>情報</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(_error))
{
    <p style="color: red;">@_error</p>
}
else if (_system == null)
{
    <p>No data.</p>
}
else
{
    <table class="info-table">
        <tr><th>Host</th><td>@(_system.ServerInfo?.HostName ?? "-")</td></tr>
        <tr><th>Version</th><td>@(_system.ServerInfo?.Version ?? "-")</td></tr>
        <tr>
            <th>Latest</th>
            <td>
                @if (_latestRelease != null && !string.IsNullOrEmpty(_latestRelease.Tag) && !string.IsNullOrEmpty(_latestRelease.Url))
                {
                    <a href="@_latestRelease.Url" target="_blank" rel="noopener noreferrer">@_latestRelease.Tag</a>
                }
                else
                {
                    <span>-</span>
                }
            </td>
        </tr>
        <tr><th>Platform</th><td>@(_system.ServerInfo?.Platform ?? "-")</td></tr>
    </table>
}

@code {
    private SystemSnapshot? _system;
    private LatestReleaseInfo? _latestRelease;
    private string? _error;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
        await LoadLatestReleaseAsync();
        _loading = false;
    }

    private async Task ReloadAsync()
    {
        var res = await Api.GetSystemAsync();
        if (!res.Ok)
        {
            _error = res.Error ?? "Failed to load.";
            return;
        }
        _error = null;
        _system = res.Data;
    }

    private async Task LoadLatestReleaseAsync()
    {
        var res = await Api.GetLatestReleaseAsync();
        if (res.Ok && res.Data != null)
        {
            _latestRelease = res.Data;
        }
    }
}
