@page "/makescript"
@using System.Text.Json
@using Amatsukaze.Shared
@inject IAmatsukazeApi Api
@inject AmatsukazeWebUI.Api.ApiBaseAddress ApiBase
@inject NavigationManager Nav

<h3>スクリプト生成</h3>

<p>
    @if (!string.IsNullOrEmpty(_downloadUrl))
    {
        <a class="btn btn-secondary" href="@_downloadUrl" download="@_downloadName">バッチファイル作成</a>
    }
</p>

@if (_loading)
{
    <p>Loading...</p>
}
else
{
    @if (!string.IsNullOrEmpty(_error))
    {
        <p style="color: red;">@_error</p>
    }
    <h4>編集</h4>
    @if (_edit == null)
    {
        <p>No data.</p>
    }
    else
    {
        <table class="table">
            <tr>
                <th>接続先</th>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm @(IsLocalHost ? "btn-primary" : "btn-secondary")"
                                @onclick="() => SetTargetHost(true)">ローカル</button>
                        <button class="btn btn-sm @(!IsLocalHost ? "btn-primary" : "btn-secondary")"
                                @onclick="() => SetTargetHost(false)">リモート</button>
                    </div>
                </td>
            </tr>
            <tr>
                <th>スクリプト</th>
                <td>
                    <label class="settings-check" style="margin-right: 8px;">
                        <input type="radio" name="scriptType" value="bat"
                               checked="@IsBatSelected"
                               disabled="@IsBatDisabled"
                               @onchange="OnScriptTypeChanged" />
                        Windowsバッチ
                    </label>
                    <label class="settings-check">
                        <input type="radio" name="scriptType" value="sh"
                               checked="@IsShSelected"
                               disabled="@IsShDisabled"
                               @onchange="OnScriptTypeChanged" />
                        Linuxシェル
                    </label>
                </td>
            </tr>
            <tr>
                <th>プロファイル</th>
                <td>
                    <select value="@_edit.Profile" @onchange="OnProfileChanged">
                        <option value="">(None)</option>
                        @foreach (var name in _profileNames)
                        {
                            <option value="@name">@name</option>
                        }
                    </select>
                </td>
            </tr>
            <tr>
                <th>優先度</th>
                <td>
                    <select value="@_edit.Priority" @onchange="OnPriorityChanged">
                        @foreach (var p in _priorities)
                        {
                            <option value="@p">@p</option>
                        }
                    </select>
                </td>
            </tr>
            <tr>
                <th>出力先</th>
                <td>
                    <div class="makescript-outdir">
                        <PathSuggestInput Value="@(_edit.OutDir ?? string.Empty)"
                                          ValueChanged="OnOutDirChanged"
                                          AllowFiles="false"
                                          AllowDirs="true" />
                    </div>
                </td>
            </tr>
            <tr>
                <th>追加時バッチ</th>
                <td>
                    <select value="@_edit.AddQueueBat" @onchange="OnAddQueueBatChanged">
                        <option value="">(None)</option>
                        @foreach (var name in _addQueueBatFiles)
                        {
                            <option value="@name">@name</option>
                        }
                    </select>
                </td>
            </tr>
            <tr>
                <th>NAS</th>
                <td>
                    <label class="settings-check">
                        <input type="checkbox" checked="@_edit.IsNasEnabled" @onchange="OnNasEnabledChanged" />
                        TSをNASにコピーしてそれをソース指定する
                    </label>
                </td>
            </tr>
            @if (_edit.IsNasEnabled)
            {
                <tr>
                    <th>NAS保存先</th>
                    <td><input value="@_edit.NasDir" @oninput="OnNasDirChanged" /></td>
                </tr>
                <tr>
                    <th>NASオプション</th>
                    <td>
                        <label class="settings-check" style="margin-right: 10px;">
                            <input type="checkbox" checked="@_edit.MoveAfter" @onchange="OnMoveAfterChanged" />
                            コピーしたTSをtransferedへ移動
                        </label>
                        <label class="settings-check" style="margin-right: 10px;">
                            <input type="checkbox" checked="@_edit.ClearEncoded" @onchange="OnClearEncodedChanged" />
                            succeededを空にする
                        </label>
                        <label class="settings-check">
                            <input type="checkbox" checked="@_edit.WithRelated" @onchange="OnWithRelatedChanged" />
                            関連ファイルもコピー
                        </label>
                    </td>
                </tr>
            }
            <tr>
                <th>WOL</th>
                <td>
                    <input type="checkbox" checked="@_edit.IsWakeOnLan" @onchange="OnWakeOnLanChanged" disabled="@IsLocalHost" />
                </td>
            </tr>
            @if (CanEditWol)
            {
                <tr>
                    <th>WOL設定</th>
                    <td>
                        <input value="@_wolSubnet" @oninput="OnWolSubnetChanged" placeholder="サブネット" />
                        <input value="@_wolMac" @oninput="OnWolMacChanged" placeholder="MAC" style="margin-left: 8px;" />
                    </td>
                </tr>
            }
            <tr>
                <th>_EDCBX_DIRECT_</th>
                <td>
                    <input type="checkbox" checked="@_edit.IsDirect" @onchange="OnDirectChanged" />
                </td>
            </tr>
        </table>
    }

    <h4>プレビュー</h4>
    @if (_preview == null)
    {
        <p>No preview.</p>
    }
    else
    {
        <pre class="makescript-preview">@(_preview.CommandLine ?? "")</pre>
    }
}

@code {
    private MakeScriptData? _data;
    private MakeScriptData? _edit;
    private MakeScriptPreview? _preview;
    private string? _error;
    private bool _loading = true;
    private bool _updating;
    private readonly List<string> _profileNames = new();
    private readonly List<string> _addQueueBatFiles = new();
    private readonly List<int> _priorities = new() { 1, 2, 3, 4, 5 };
    private string? _downloadUrl;
    private string _downloadName = "AmatsukazeAddTask.bat";
    private bool _isLocalHost;
    private string _scriptType = "bat";
    private bool _serverIsWindows = true;
    private string? _remoteHost;
    private string? _wolSubnet;
    private string? _wolMac;

    protected override Task OnInitializedAsync() => ReloadAsync();

    private async Task ReloadAsync()
    {
        _loading = true;
        _error = null;
        _data = null;
        _edit = null;
        _preview = null;
        _profileNames.Clear();
        _addQueueBatFiles.Clear();
        _downloadUrl = null;

        var dataTask = Api.GetMakeScriptAsync();
        var profileTask = Api.GetProfilesAsync();
        var envTask = Api.GetServerEnvironmentAsync();
        var batTask = Api.GetAddQueueBatFilesAsync();

        await Task.WhenAll(dataTask, profileTask, envTask, batTask);

        var dataRes = await dataTask;
        var profileRes = await profileTask;
        var envRes = await envTask;
        var batRes = await batTask;

        if (!dataRes.Ok)
        {
            _error = dataRes.Error ?? "Failed to load makescript.";
        }
        else
        {
            _data = dataRes.Data;
            _edit = Clone(_data);
        }

        if (profileRes.Ok && profileRes.Data != null)
        {
            foreach (var p in profileRes.Data)
            {
                if (p.TryGetProperty("Name", out var nameProp))
                {
                    var name = nameProp.GetString();
                    if (!string.IsNullOrWhiteSpace(name))
                    {
                        _profileNames.Add(name);
                    }
                }
                else if (p.TryGetProperty("name", out var namePropLower))
                {
                    var name = namePropLower.GetString();
                    if (!string.IsNullOrWhiteSpace(name))
                    {
                        _profileNames.Add(name);
                    }
                }
            }
        }

        if (batRes.Ok && batRes.Data != null)
        {
            _addQueueBatFiles.AddRange(batRes.Data);
        }

        if (envRes.Ok && envRes.Data != null)
        {
            _serverIsWindows = !envRes.Data.IsServerLinux;
        }
        _scriptType = _serverIsWindows ? "bat" : "sh";
        _remoteHost = GetRemoteHost();

        if (_edit != null)
        {
            var req = new MakeScriptGenerateRequest
            {
                MakeScriptData = _edit,
                TargetHost = _isLocalHost ? "local" : "remote",
                ScriptType = _scriptType,
                RemoteHost = _isLocalHost ? null : _remoteHost,
                Subnet = _wolSubnet,
                Mac = _wolMac
            };
            var previewRes = await Api.GetMakeScriptPreviewAsync(req);
            if (!previewRes.Ok && string.IsNullOrEmpty(_error))
            {
                _error = previewRes.Error ?? "Failed to load preview.";
            }
            else
            {
                _preview = previewRes.Data;
                UpdateDownload();
            }
        }

        _loading = false;
    }

    private static MakeScriptData? Clone(MakeScriptData? src)
    {
        if (src == null)
        {
            return null;
        }
        return new MakeScriptData
        {
            Profile = src.Profile,
            OutDir = src.OutDir,
            NasDir = src.NasDir,
            IsNasEnabled = src.IsNasEnabled,
            IsWakeOnLan = src.IsWakeOnLan,
            MoveAfter = src.MoveAfter,
            ClearEncoded = src.ClearEncoded,
            WithRelated = src.WithRelated,
            IsDirect = src.IsDirect,
            Priority = src.Priority,
            AddQueueBat = src.AddQueueBat
        };
    }

    private async Task OnProfileChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.Profile = e.Value?.ToString();
        await UpdatePreviewAsync();
    }

    private async Task OnPriorityChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        if (int.TryParse(e.Value?.ToString(), out var value))
        {
            _edit.Priority = value;
            await UpdatePreviewAsync();
        }
    }

    private async Task OnOutDirChanged(string value)
    {
        if (_edit == null) return;
        _edit.OutDir = value;
        await UpdatePreviewAsync();
    }

    private async Task OnAddQueueBatChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.AddQueueBat = e.Value?.ToString();
        await UpdatePreviewAsync();
    }

    private async Task OnNasEnabledChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.IsNasEnabled = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task OnNasDirChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.NasDir = e.Value?.ToString();
        await UpdatePreviewAsync();
    }

    private async Task OnMoveAfterChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.MoveAfter = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task OnClearEncodedChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.ClearEncoded = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task OnWithRelatedChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.WithRelated = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task OnWakeOnLanChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.IsWakeOnLan = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task OnWolSubnetChanged(ChangeEventArgs e)
    {
        _wolSubnet = e.Value?.ToString();
        await UpdatePreviewAsync();
    }

    private async Task OnWolMacChanged(ChangeEventArgs e)
    {
        _wolMac = e.Value?.ToString();
        await UpdatePreviewAsync();
    }

    private async Task OnDirectChanged(ChangeEventArgs e)
    {
        if (_edit == null) return;
        _edit.IsDirect = e.Value is bool b && b;
        await UpdatePreviewAsync();
    }

    private async Task UpdatePreviewAsync()
    {
        if (_edit == null || _updating)
        {
            return;
        }
        _updating = true;
        _error = null;
        var updateRes = await Api.UpdateMakeScriptAsync(_edit);
        if (!updateRes.Ok)
        {
            _error = updateRes.Error ?? "Failed to update makescript.";
            _updating = false;
            return;
        }
        var req = new MakeScriptGenerateRequest
        {
            MakeScriptData = _edit,
            TargetHost = _isLocalHost ? "local" : "remote",
            ScriptType = _scriptType,
            RemoteHost = _isLocalHost ? null : _remoteHost,
            Subnet = _wolSubnet,
            Mac = _wolMac
        };
        var previewRes = await Api.GetMakeScriptPreviewAsync(req);
        if (!previewRes.Ok)
        {
            _error = previewRes.Error ?? "Failed to load preview.";
        }
        else
        {
            _preview = previewRes.Data;
            UpdateDownload();
        }
        _updating = false;
    }

    private void UpdateDownload()
    {
        if (_preview == null || string.IsNullOrWhiteSpace(_preview.CommandLine))
        {
            _downloadUrl = null;
            return;
        }
        var content = _preview.CommandLine + "\r\n";
        _downloadName = _scriptType == "sh" ? "AmatsukazeAddTask.sh" : "AmatsukazeAddTask.bat";
        _downloadUrl = "data:text/plain;charset=utf-8," + Uri.EscapeDataString(content);
    }

    private void SetTargetHost(bool local)
    {
        _isLocalHost = local;
        if (local)
        {
            _scriptType = _serverIsWindows ? "bat" : "sh";
        }
        _ = UpdatePreviewAsync();
    }

    private async Task OnScriptTypeChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            return;
        }
        _scriptType = value;
        await UpdatePreviewAsync();
    }

    private string GetRemoteHost()
    {
        var baseUri = ApiBase.Uri;
        if (string.Equals(baseUri.Scheme, Uri.UriSchemeFile, StringComparison.OrdinalIgnoreCase))
        {
            baseUri = new Uri(Nav.BaseUri);
        }
        return baseUri.Host;
    }

    private bool IsLocalHost => _isLocalHost;
    private bool IsBatSelected => _scriptType == "bat";
    private bool IsShSelected => _scriptType == "sh";
    private bool IsBatDisabled => IsLocalHost && !_serverIsWindows;
    private bool IsShDisabled => IsLocalHost && _serverIsWindows;
    private bool CanEditWol => !IsLocalHost && _edit?.IsWakeOnLan == true;
}
